apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: legal-compliance

resources:
  - ../../base

# Local uses minimal replicas
replicas:
  - name: frontend
    count: 1

# Local image tags (built with minikube docker-env)
images:
  - name: legal-compliance-frontend
    newTag: local

# Patches for local environment
patches:
  # Delete all HPAs (not needed locally)
  - patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: placeholder
    target:
      kind: HorizontalPodAutoscaler

  # Reduce resource requests for local
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "50m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "128Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "512Mi"
    target:
      kind: Deployment

  # Convert Frontend service to NodePort
  - patch: |-
      - op: replace
        path: /spec/type
        value: NodePort
      - op: add
        path: /spec/ports/0/nodePort
        value: 30000
    target:
      kind: Service
      name: frontend

commonLabels:
  environment: local
